name: CI Minimal Image Boot

on:
  push:
    branches: ["main"]
    paths:
      - "Dockerfile"
      - "Dockerfile.base"
      - "requirements.instance.txt"
      - "scripts/supervisord.conf"
      - "scripts/container_smoke.sh"
      - "src/**"
      - ".github/workflows/ci-minimal-image.yml"
  pull_request:
    paths:
      - "Dockerfile"
      - "Dockerfile.base"
      - "requirements.instance.txt"
      - "scripts/supervisord.conf"
      - "scripts/container_smoke.sh"
      - "src/**"
      - ".github/workflows/ci-minimal-image.yml"
  workflow_dispatch:

jobs:
  minimal-build-and-boot:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          # Use host docker driver so `load: true` images are resolvable
          # by subsequent local builds in the same job.
          driver: docker

      - name: Build base image (local)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.base
          push: false
          load: true
          tags: cres-base-ci:${{ github.sha }}

      - name: Build app image (local)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          build-args: |
            BASE_IMAGE=cres-base-ci:${{ github.sha }}
          push: false
          load: true
          tags: cres-app-ci:${{ github.sha }}

      - name: Start minimal dependencies
        run: |
          set -euxo pipefail
          docker network create cres-ci || true
          docker run -d --name temporal-ci --network cres-ci temporalio/auto-setup:1.24.2
          docker run -d --name minio-ci --network cres-ci \
            -e MINIO_ROOT_USER=cres \
            -e MINIO_ROOT_PASSWORD='Qh@113113' \
            quay.io/minio/minio:latest server /data --address :9000 --console-address :9001

      - name: Boot app container and run smoke
        run: |
          set -euxo pipefail
          resolve_host() {
            local name="$1"
            local host=""
            for _ in $(seq 1 30); do
              host="$(docker inspect -f '{{if .State.Running}}{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}{{end}}' "$name" 2>/dev/null || true)"
              if [ -n "$host" ]; then
                echo "$host"
                return 0
              fi
              sleep 1
            done
            # Fallback to docker DNS name in case IP is temporarily unavailable.
            echo "$name"
            return 0
          }
          TEMPORAL_HOST="$(resolve_host temporal-ci)"
          MINIO_HOST="$(resolve_host minio-ci)"
          docker run -d --name app-ci --network cres-ci \
            -e CONTROL_PLANE_MODE=external \
            -e TEMPORAL_ADDRESS=${TEMPORAL_HOST}:7233 \
            -e MINIO_ENDPOINT=${MINIO_HOST}:9000 \
            -e MINIO_SECURE=false \
            -e MINIO_ACCESS_KEY=cres \
            -e MINIO_SECRET_KEY='Qh@113113' \
            -e AWS_ACCESS_KEY_ID=cres \
            -e AWS_SECRET_ACCESS_KEY='Qh@113113' \
            -e ENABLE_WEB=false \
            cres-app-ci:${{ github.sha }}
          docker exec app-ci /bin/bash /workspace/scripts/container_smoke.sh

      - name: Cleanup
        if: always()
        run: |
          docker rm -f app-ci temporal-ci minio-ci || true
          docker network rm cres-ci || true

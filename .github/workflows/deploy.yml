name: Build and Push to GHCR
run-name: Build (release) ${{ inputs.note }} ${{ github.ref_name }} @ ${{ github.sha }}

on:
  workflow_dispatch:
    inputs:
      note:
        description: "Optional label (e.g., fix qemu / test build)"
        required: false
        default: ""
      promote_stable:
        description: "Also publish stable tag (manual promotion)"
        required: false
        type: boolean
        default: false
        
env:
  REGISTRY: ghcr.io
  # Centralize image name for consistency
  IMAGE_NAME: ${{ github.repository }}

jobs:
  filter:
    runs-on: ubuntu-latest
    outputs:
      base: ${{ steps.filter.outputs.base || 'false' }}
      image_name_lower: ${{ steps.lowercase.outputs.image_name_lower }}
    steps:
      - name: Lowercase image name (fix naming)
        id: lowercase
        run: |
          echo "image_name_lower=${IMAGE_NAME,,}" >> $GITHUB_OUTPUT
        shell: bash

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # Shallow clone for speed

      - name: Filter changed files
        id: filter
        if: github.event_name != 'workflow_dispatch'
        uses: dorny/paths-filter@v3
        with:
          filters: |
            base:
              - 'Dockerfile.base'

  build-base:
    needs: filter
    if: >-
      (github.event_name == 'workflow_dispatch') ||
      (needs.filter.outputs.base == 'true' && github.event_name != 'pull_request')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      # Add security scope for GHCR
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Pre-clean runner disk (build-app)
        run: |
          set -euxo pipefail
          df -h
          docker system df || true
          docker rm -f $(docker ps -aq) 2>/dev/null || true
          docker system prune -af --volumes || true
          df -h
          docker system df || true


      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: network=host # Faster builds

      - name: Log in to GHCR (secure OIDC auth)
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          # OIDC auth (better than GITHUB_TOKEN for long-term use)
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker (tags/labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ needs.filter.outputs.image_name_lower }}-base
          # Add semantic tags (latest + commit SHA)
          tags: |
            type=raw,value=latest
            type=sha,format=short
          # Add standard labels for maintainability
          labels: |
            org.opencontainers.image.title=${{ github.event.repository.name }}-base
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.source=${{ github.event.repository.html_url }}
            org.opencontainers.image.created=${{ github.event.created_at }}

      - name: Build and push Base image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.base
          platforms: linux/amd64
          push: ${{ github.event_name != 'pull_request' }} # Don't push on PRs
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # Reduce runner disk pressure on self-hosted nodes
          provenance: false
          sbom: false

  build-app:
    needs: [filter, build-base]
    if: >-
      always() &&
      (needs.build-base.result == 'success' || needs.build-base.result == 'skipped') &&
      (github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Pre-clean runner disk (build-app)
        run: |
          set -euxo pipefail
          df -h
          docker system df || true
          docker rm -f $(docker ps -aq) 2>/dev/null || true
          docker system prune -af --volumes || true
          df -h
          docker system df || true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: network=host

      - name: Log in to GHCR
        uses: docker/login-action@v3
        if: github.event_name != 'pull_request'
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build App image (smoke, no push)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          platforms: linux/amd64
          build-args: |
            BASE_IMAGE=python:3.10-slim
          push: false
          load: true
          tags: cres-smoke:${{ github.sha }}

      - name: Start smoke dependencies
        run: |
          set -euxo pipefail
          docker network create cres-smoke || true
          docker run -d --name temporal-smoke --network cres-smoke \
            --entrypoint temporal \
            temporalio/server:1.24.2 \
            server start-dev --ip 0.0.0.0
          docker run -d --name minio-smoke --network cres-smoke \
            -e MINIO_ROOT_USER=cres \
            -e MINIO_ROOT_PASSWORD='Qh@113113' \
            quay.io/minio/minio:latest server /data --address :9000 --console-address :9001

      - name: Resolve smoke dependency endpoints
        id: smoke_deps
        run: |
          set -euxo pipefail
          resolve_ip() {
            local name="$1"
            local ip=""
            for _ in $(seq 1 60); do
              ip="$(docker inspect -f '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}' "$name" 2>/dev/null || true)"
              if [ -n "$ip" ]; then
                echo "$ip"
                return 0
              fi
              sleep 1
            done
            echo "Failed to resolve IP for $name" >&2
            docker ps -a >&2 || true
            docker logs "$name" >&2 || true
            return 1
          }
          TEMPORAL_IP="$(resolve_ip temporal-smoke)"
          MINIO_IP="$(resolve_ip minio-smoke)"
          echo "temporal_ip=$TEMPORAL_IP" >> "$GITHUB_OUTPUT"
          echo "minio_ip=$MINIO_IP" >> "$GITHUB_OUTPUT"

      - name: Run container smoke checks
        run: |
          set -euxo pipefail
          docker run -d --name app-smoke --network cres-smoke \
            -e CONTROL_PLANE_MODE=external \
            -e TEMPORAL_ADDRESS=${{ steps.smoke_deps.outputs.temporal_ip }}:7233 \
            -e MINIO_ENDPOINT=${{ steps.smoke_deps.outputs.minio_ip }}:9000 \
            -e MINIO_SECURE=false \
            -e MINIO_ACCESS_KEY=cres \
            -e MINIO_SECRET_KEY='Qh@113113' \
            -e AWS_ACCESS_KEY_ID=cres \
            -e AWS_SECRET_ACCESS_KEY='Qh@113113' \
            -e ENABLE_WEB=false \
            cres-smoke:${{ github.sha }}
          docker exec app-smoke /bin/bash /workspace/scripts/container_smoke.sh

      - name: Cleanup smoke containers
        if: always()
        run: |
          docker rm -f app-smoke temporal-smoke minio-smoke || true
          docker network rm cres-smoke || true

      - name: Reclaim docker disk after smoke
        if: always()
        run: |
          set -euxo pipefail
          docker system prune -af --volumes || true
          df -h
          docker system df || true

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ needs.filter.outputs.image_name_lower }}
          tags: |
            type=raw,value=canary
            type=raw,value=stable,enable=${{ github.event_name == 'workflow_dispatch' && inputs.promote_stable }}
            type=sha,format=short
          labels: |
            org.opencontainers.image.title=${{ github.event.repository.name }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.source=${{ github.event.repository.html_url }}
            org.opencontainers.image.created=${{ github.event.created_at }}

      - name: Build and push App image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          platforms: linux/amd64
          build-args: |
            BASE_IMAGE=${{ env.REGISTRY }}/${{ needs.filter.outputs.image_name_lower }}-base:latest
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # Reduce runner disk pressure on self-hosted nodes
          provenance: false
          sbom: false
